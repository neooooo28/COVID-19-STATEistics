---
title: "UCLA COVID-19 Project"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    # vertical_layout: scroll
    theme: bootstrap 
    social: menu
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warniing=FALSE, message=FALSE,
                      collapse = TRUE, comment = "#>")
```

```{r libraries, include=FALSE}
## Load Libraries

# - Data Wrangling
# library(tidyverse)
library(dplyr)       # core wrangling
library(tidyr)       # pivot
library(stringr)     # strings
library(lubridate)   # date object conversion
library(data.table)  # fread, fast handling

# - Tables 
library(readr)       # read_csv
library(tibble)      # as_tibble()
library(knitr)       # knit kables
library(kableExtra)  # {r results = 'asis'}

# - Plots
library(ggplot2)     # core plotting
library(scales)      # x,y scales
library(colorspace)  # sequence, diverging colors
library(ggrepel)     # labels, geom_text()
library(plotly)      # interactive plots

# - Math
library(deSolve)    # SIR Model
library(zoo)        # moving average, rollmean

# - URL 
library(RCurl)      # handling links

# - Shiny
library(shiny)
library(flexdashboard)
```

```{r}
## Load Datasets
# - limit running the download links in a day to avoid overloading requests and getting a time out

## Create a new folder containing all downloaded datasets
# getwd() 
# dir.create("00_data") 

## 1. John Hopkins CSSE (jhu)
# url.path <- paste0('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/',
#                    'master/csse_covid_19_data/csse_covid_19_time_series')
# filename_US <- c('time_series_covid19_confirmed_US.csv',
#                  'time_series_covid19_deaths_US.csv')
# dest.path <- paste0(getwd(),"/00_data")
# # Download files to local
# download <- function(filename) {
#   url = file.path(url.path, filename)
#   dest = file.path(dest.path, filename)
#   download.file(url, dest)
# }
# bin <- lapply(filename_US, download)
# df_jhu <- read_csv("00_data/time_series_covid19_confirmed_US.csv")
# df_jhu <- read_csv("00_data/time_series_covid19_deaths_US.csv")

## 1.5 COVIDTracking.com (ct)
link_ct <- paste0("https://raw.githubusercontent.com/COVID19Tracking/covid-tracking-data/master/data/",
                  "states_daily_4pm_et.csv")
dest_ct <- paste0(getwd(),"/00_data")
filename_ct <- "CT_states_daily_4pm_et.csv"
download.file(link_ct, file.path(dest_ct, filename_ct))
df_ct <- read_csv(file.path("00_data", filename_ct))


## 2. Google Community Mobility Report (gmcr)
link_gmcr <- "https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv?cachebust=57b4ac4fc40528e2"
dest_gmcr <- paste0(getwd(),"/00_data")
# filename_gmcr <- "Global_Mobility_Report.csv" # this is the default name from Google

### ONY RUN ONCE -- avoid requesting downloads everytime you run this shiny app
download.file(link_gmcr, dest_gmcr) # -- 
### COMMENT AFTER

df_gmcr <- fread("00_data/Global_Mobility_Report.csv")

```



```{r}
## Data Cleaning

## 1. COVID Tracking
df_ct_clean <- df_ct %>% 
  filter(state %in% state.abb) %>% 
  mutate(date = ymd(date)) %>% 
  arrange(state, date) %>% 
  
  # Rename columns
  select(date, state, positive, negative, 
         total_tests=totalTestResults, 
         deaths = death,
         daily_cases = positiveIncrease,
         daily_tests = totalTestResultsIncrease,
         daily_deaths = deathIncrease) %>% 
  
  # 5 days because it's the average time between onset and confirmed
  group_by(state) %>% 
  mutate(ave_5d_cases = zoo::rollmean(x=daily_cases, k=5, fill=NA, align='right'),
         ave_5d_tests = zoo::rollmean(x=daily_tests, k=5, fill=NA, align='right'),
         ave_5d_deaths = zoo::rollmean(x=daily_deaths, k=5, fill=NA, align='right')
  ) %>% 
  ungroup() %>%  
  
  # Reorder columns such that: id | cases | tests | deaths
  select(date, state,
         positive, negative, daily_cases, ave_5d_cases, 
         total_tests, daily_tests, ave_5d_tests, 
         deaths, daily_deaths, ave_5d_deaths) %>% 
  
  # Convert 2-letter state abbreviation to full state names:
  left_join(data.frame(state=state.abb, state.name, stringsAsFactors=FALSE), 
            by=c("state")) %>% 
  select(-state) %>% 
  select(date, state=state.name, everything())


## 2. Google Community

# only include US states
df_gmcr <- fread("00_data/Global_Mobility_Report.csv") %>% 
  filter(country_region == "United States") %>% 
  filter(sub_region_1 %in% state.name) %>% 
  filter(sub_region_2 == "") %>% 
  select(-c(country_region_code, country_region, sub_region_2)) %>%
  rename(state = sub_region_1, 
         `Retail & Recreation` = retail_and_recreation_percent_change_from_baseline,
         `Grocery & Pharmacy` = grocery_and_pharmacy_percent_change_from_baseline,
         `Parks` = parks_percent_change_from_baseline,
         `Transit Stations` = transit_stations_percent_change_from_baseline,
         `Workplaces` = workplaces_percent_change_from_baseline,
         `Residential` = residential_percent_change_from_baseline) %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  as_tibble() %>% 
  tidyr::pivot_longer(-c(state, date), names_to="place", values_to="index") %>% 
  group_by(state, place) %>% 
  # 7 days so we have a week-on-week analysis
  mutate(ave_7d = zoo::rollmean(x=index, k=7, fill=NA, align='right')) %>% 
  ungroup()

```

```{r}
## Get last update date

# When was ct data last updated?
start_date_ct <- df_ct %>% pull(date) %>% min
end_date_ct <- df_ct %>% pull(date) %>% max

# When was Google Mobility data last updated?
start_date_gmcr <- df_gmcr %>% pull(date) %>% min
end_date_gmcr <- df_gmcr %>% pull(date) %>% max
```


Background
======================================================================

#### **WHAT HAPPENED?**

**COVID-19** is the disease caused by the new coronavirus that emerged in China in December 2019. 

Its symptoms include cough, fever, shortness of breath, muscle aches, sore throat, unexplained loss of taste or smell, diarrhea, and headache. COVID-19 cam be severe, and some cases have caused death. 

The new coronavirus can be spread from person to person It is diagnosed with a laboratory test. 

**There is no coronavirus vaccine yet.** Prevention involves frequent hand-washing, coughing into the bend of your elbow, staying home when you are sick, and wearing a cloth face or mask covering if you cannot practice social distancing.

***

#### **WHAT IS HAPPENING?**

```{r}
# change values in the future
# as.character(number)
tested <- "11,077,179"
total_confirmed <- "1,458,787"
total_deaths <- "83,015"
```

Currentlyin the United States, of the **`r tested`** tested individuals, there are **`r total_confirmed`** current cases and **`r total_deaths`** deaths.

***

#### **WHAT WILL HAPPEN?**

- Avoid large crowds and social gathering
- Stay more than 6 feet away from anyone
- Proper diet and exercise
- P.L.U.R.

***

US States
======================================================================

Input Sidebar {.sidebar}
----------------------------------------------------------------------

### Sidebar

You can embed Shiny inputs and outputs in your document. Outputs are automatically updated whenever inputs change.  

```{r}
inputPanel(
  selectInput(inputId="state", label="Select a State:",
              choices = state.name, selected = "California"),
  
  dateRangeInput("daterange1", "Date range:",
                 start = "2020-02-01",
                 # end = max(as_of_date_jhu)
                 end   = "2020-05-15")
)
```


Columns {.tabset}
----------------------------------------------------------------------

### Daily Confirmed Cases

```{r}

```

### Daily Deaths

```{r}

```

***

Mobility
======================================================================

### **GOOGLE MOBILITY DATA** - How Are Americans Moving? 

```{r gmcr, echo=FALSE}
## SHINY APP 
ui_gmcr <- fillPage(
  # UI Inputs
  inputPanel(
    # Input: US States
    selectInput(inputId="state_gmcr", label="Select a State:",
                choices = datasets::state.name, selected = "California"),
    # Input: Date range (2 - start and end)
    dateRangeInput(inputId="daterange_gmcr", label="Date:",
                   start = start_date_gmcr, end = end_date_gmcr,
                   min = start_date_gmcr, max = end_date_gmcr)
  ),
  # UI Outputs
  plotOutput(outputId="plot_gmcr")
)
server_gmcr <- function(input, output, session) {
  # Filtered Data
  chosen_state <- reactive({
    input$state_gmcr
  })
  filteredData <- reactive({
    df_gmcr %>% 
      filter(state == input$state_gmcr) %>% 
      filter(date >= input$daterange_gmcr[1] &
               date <= input$daterange_gmcr[2])
  })
  # Plot
  output$plot_gmcr <- renderPlot({
    ggplot(data = filteredData(),
           aes(x = date, group = place)) +
      geom_hline(yintercept = 0, col="black", size=0.2) + 
      geom_line(aes(y = index), col="gray", lty=2, alpha=0.7, size=0.6) +
      geom_line(aes(y = ave_7d), col="dodgerblue3", size=1.3) +
      facet_wrap(~ place) +
      
      ## Formatting
      scale_x_date(labels=date_format("%m/%d"), date_breaks="2 weeks") +
      scale_y_continuous(labels=function(x) paste0(x,"%")) +
      theme_minimal() +
      labs(x="Date") +
      theme(
        # Border
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "gray"),
        # Text
        # axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=10),
        strip.text.x = element_text(size=12, face="bold"),
        # Labels
        plot.title = element_text(face="bold", hjust=0.5, size=11),
        plot.subtitle = element_text(face="italic", hjust=0.5, size=8),
        plot.caption = element_text(face="italic", size=7, hjust=0, margin=margin(t=15))
      ) # +
      # Labels
      # labs(
      #   title = paste0("How People are Moving in ", chosen_state),
      #   subtitle = paste0("Percent change in baseline ",
      #                     "(7-day average) as of ",
      #                     format(end_date_gmcr, "%m/%d/%Y")),
      #   caption = paste0(
      #     "Source: Google Community Mobility Reports\n",
      #     "Note: The baseline (0%) is the median value during ",
      #     "the 5-week period from Jan 3 to Feb 6, 2020.")
      # )
  })
}
shinyApp(ui_gmcr, server_gmcr)
```

***

Map
======================================================================

### Map 

```{r}
library(leaflet)

# load confirmed data

# Join state and coordinate data


shinyApp(
  ui = bootstrapPage(
    
    tags$style(type = "text/css", "html, body {width:100%;height:100%}"),
    leafletOutput(outputId="map", width="100%", height="100%"),
    
    absolutePanel(
      top=10, left=10, width="300", class="panel panel-default",
      draggable=TRUE, style = "opacity: 0.90",
      
      selectInput(inputId="state_map", label="Select a State:",
                  choices = datasets::state.name, selected = "California")
    )
  ), # end - Shiny UI
  
  server = function(input, output) {
    # Filtered Data
    points <- reactive({
      df_jhu %>% 
        filter(state == input$state_map) %>% 
        filter(date == max(date)) %>% 
        mutate(popup = str_c(str_c(city, state, sep=", "),
                             str_c("Population:", population, sep=" "),
                             str_c("Confirmed Cases:", confirmed, sep=" "),
                             str_c("Deaths:", deaths, sep=" "),
                             sep="</br>"))
    })
    # Base map layer
    output$map <- renderLeaflet({
      leaflet(US_LatLong) %>%
        addProviderTiles(providers$CartoDB.DarkMatter) %>%
        fitBounds(~min(longitude), ~min(latitude), 
                  ~max(longitude), ~max(latitude))
    })
    # Variable map layer
    observe({
      leafletProxy("map", data=points()) %>% 
        addCircles(lng = ~longitude, lat = ~latitude, color="red", 
                   weight = 2, fillOpacity = 0.3, stroke=FALSE, 
                   radius = ~(0.8*confirmed),
                   label = ~city, popup = ~popup
        )
    })
    
  } # end - Shiny Server
) # end - Shiny App
```

***

About
======================================================================

#### **ABOUT THIS PROJECT**

This shiny application on COVID-19 is a group project completed for Statistical Consulting, STATS 141, class taught at the University of California, Los Angeles (UCLA) at the start of the pandemic during the spring quarter 2020. This project was under the supervision of Professor Mahtash Esfandiari and Samuel Baughs. 

The students were tasked to use publicly available Data 

***

#### **MEET THE TEAM**

Teammate 1

- UCLA Statistics   
- `myemail@ucla.edu`  
- LinkedIn: [username](google.com)

Teammate 2 

- UCLA Statistics   
- `myemail@ucla.edu`  
- LinkedIn: [username](google.com)

***

#### **BIBLIOGRAPHY**

Dataset: (include appropriate attribution)

- John Hopkins Center for Systems Science and Engineering (insert github link)
- Google Community Mobility Report (insert link)

Research: 

- Last Name, First Name. *Title: Lorem Ipsum*. Lorem Ipsum Journal. Accessed 15 May 2020. 

#### **BACKGROUND** 

The [Community Mobility Reports](https://www.google.com/covid19/mobility/) show movement trends by region, across different categories of places. For this particular visualization the data was subsetted only for the United States. Note that location accuracy and the understanding of categorized places varies from region to region, so Google does not recommend using the data to compare changes between countries, or between regions with different characteristics (e.g. rural versus urban areas). 

In short, the graph is an indicator if Americans are going back to their normal routines earlier this year. If the blue line is closer to the baseline, 0%, it means that people in that area are doing similar activities like they did in January. 

The data shows visitors to (or time spent in) categorized places change compared to the **baseline** days. A baseline day represents a *normal* value for that day of the week, in this case it is the median value from the 5-week period from January 3rd to February 6th 2020. Each location visit is classified into 6 categories:

```{r}
data.frame(
  Location = c("Retail & Recreation",
               "Grocery & Pharmacy",
               "Parks",
               "Transit Stations",
               "Workplaces",
               "Residential"),
  Description = c("mobility trends for places like restaurants, cafes, shopping centers, theme parks, museums, libraries, and movie theaters",
                "mobility trends for places like grocery markets, food warehouses, farmers markets, specialty food shops, drug stores, and pharmacies",
                  "mobility trends for places like national parks, public beaches, marinas, dog parks, plazas, and public gardens",
                  "mobility trends for places like public transport hubs such as subway, bus, and train stations",
                  "mobility trends for places of work",
                  "mobility trends for places of residence")
) %>% 
  kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```









